// Generated by CoffeeScript 1.6.2
(function() {
  var Client, Collector, EventEmitter, applyOp, find, normalizePayload, objInclude, _, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  _ref = require('./util'), objInclude = _ref.objInclude, find = _ref.find, _ = _ref._, EventEmitter = _ref.EventEmitter;

  normalizePayload = require('./normalizePayload');

  Client = require('./client');

  applyOp = require('./applyOp');

  Collector = (function(_super) {
    __extends(Collector, _super);

    function Collector(options) {
      var status,
        _this = this;

      status = 'waiting';
      this.data = {};
      this.identity = options.identity || {};
      this.network = options.network || {};
      this.debug = options.onDebug || function() {};
      this.onData = options.onData || function() {};
      this.error = options.onError || console.error;
      Collector.__super__.constructor.call(this, {
        wildcard: true,
        maxListeners: Infinity
      });
      this.onRegister = options.onRegister || function(identity, receiver, err) {
        _this.client = Client(_this.network);
        return _this.client.register(identity, receiver, err);
      };
      this.on('ready', function() {
        _this.debug('ready!');
        return _this.status = 'ready';
      });
      this.on('data', function(data, event) {
        var eventName, normEvent, op, _i, _len, _ref1;

        this.debug('Sending new data notification!');
        if (event.oplist) {
          _ref1 = event.oplist;
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            op = _ref1[_i];
            eventName = "" + event.root + "." + op.path;
            normEvent = _.merge({}, event, op);
            delete normEvent.oplist;
            this.emit(eventName, data, normEvent);
          }
        }
        return this.onData(data, event);
      });
    }

    Collector.prototype.register = function(done) {
      var _this = this;

      done || (done = function() {});
      return this.onRegister(this.identity, this.receive.bind(this), function(err) {
        done(err);
        if (err) {
          return _this.error({
            context: 'Error: Stream - Could not initiate data transfer.',
            error: err
          });
        } else {
          return _this.debug('Registered with Stream.');
        }
      });
    };

    Collector.prototype.receive = function(name, event) {
      var nm,
        _this = this;

      this.lastUpdated = new Date(event.timestamp);
      this.debug('Received data.', {
        name: name,
        event: event
      });
      switch (name) {
        case 'manifest':
          this.manifest = event;
          return this.checkReady();
        case 'payload':
          this.data[event.root] = _.clone(event.data, true);
          nm = normalizePayload(event);
          if (nm.oplist.length > 0) {
            this.emit('data', this.data, nm);
          }
          return this.checkReady();
        case 'delta':
          return this.ready(function() {
            _this.debug("Updating collection '" + event.root + "' with '" + (event.oplist.map(function(o) {
              return o.operation;
            }).join(',')) + "'.");
            applyOp(_this.data, event);
            return _this.emit('data', _this.data, event);
          });
      }
    };

    Collector.prototype.checkReady = function() {
      var checkManifest, ready;

      checkManifest = function(data, manifest) {
        var name;

        if (manifest == null) {
          return false;
        }
        for (name in manifest) {
          if (name !== 'timestamp') {
            if (!data[name]) {
              return false;
            }
          }
        }
        return true;
      };
      ready = checkManifest(this.data, this.manifest);
      this.debug("Checking if we're ready...", {
        manifest: this.manifest != null,
        allReceived: ready
      });
      if (ready) {
        return this.emit('ready');
      }
    };

    Collector.prototype.ready = function(done) {
      if (this.status === 'ready') {
        return done();
      } else {
        return this.once('ready', done);
      }
    };

    Collector.prototype.reset = function(done) {
      var name;

      for (name in this.data) {
        delete this.data[name];
      }
      this.status = 'loading';
      return this.ready(done);
    };

    return Collector;

  })(EventEmitter);

  module.exports = Collector;

}).call(this);
